######################################################
# Program-specific Variables
######################################################

# Directory where final executable will be stored
OUTDIR=../bin

# List of all C source files
SRCS=userprog.c

# List of os header files
HDRS=usertraps.h

# Name of final executable
EXEC=userprog.dlx.obj

# Name of existing operating system executable (only for make run)
OSEXEC=os.dlx.obj

# Automatically-generated list of C object files from source files
OBJS=$(SRCS:%.c=%.o)


######################################################
# Compiler-specific variables
######################################################

# Name of C compiler
CC=gcc-dlx

# Name of assembler
AS=dlxasm

# Flags passed to all invocations of C compiler
CFLAGS= -mtraps -O3 -Wall

# Flags for compiler indicating search path for include files
INCDIR= -I../include

# Flags for compiler indicating which libraries should be linked
LIBS= usertraps.o
OBJLIBS=$(LIBS:%.o=../lib/%.o)

# Flags sent to the assembler
ASFLAGS=


######################################################
# Bookkeeping Variables
######################################################

# Final result of program
OUTPUT=$(OUTDIR)/$(EXEC)

# Location of scratch space to store object and other intermediate files
WORKDIR=work

# Intermediate DLX file passed from C compiler to Assembler
OUTDLX=$(EXEC:%.dlx.obj=$(WORKDIR)/%.dlx)

# LST file generated by the Assembler, not used as a target
OUTLST=$(EXEC:%.dlx.obj=$(WORKDIR)/%.lst)

# Object files from C source with proper workdir location prepended
WORKOBJS=$(OBJS:%.o=$(WORKDIR)/%.o)

# Headers translated to proper include directory
FINALHDRS=$(OSHDRS:%.h=../include/%.h)


#####################################################
# Targets and Dependencies
#####################################################

# Default target that is made when you type "make"
default: Makefile.depend $(WORKDIR) $(OUTDIR) $(OUTPUT)

# Builds dependencies for header files
Makefile.depend: $(SRCS) $(ASMSRCS) $(FINALHDRS)
	$(CC) $(INCDIR) -MM $(SRCS) $(ASMSRCS) | sed "s/^\(.*\):/$(WORKDIR)\/\1:/" > Makefile.depend

# Ensures directory for object files exists
$(WORKDIR):
	mkdir -p $@

# Ensures output directory exists
$(OUTDIR):
	mkdir -p $@

# Builds final output from DLX file using the assembler,
# then moves it to the final output directory
$(OUTPUT): $(OUTDLX)
	$(AS) $(ASFLAGS) -l $(OUTLST) $(OUTDLX)
	cp $(WORKDIR)/$(EXEC) $(OUTPUT)

# Builds DLX output file using the C compiler from all object files
$(OUTDLX): $(WORKOBJS) $(WORKASMOBJS) $(OBJLIBS)
	$(CC) $(CFLAGS) $(INCDIR) -o $@ $(WORKOBJS) $(WORKASMOBJS) $(OBJLIBS)

# Builds any given object file from C source files
$(WORKDIR)/%.o:%.c
	$(CC) $(CFLAGS) $(INCDIR) -c -o $@ $<

# Removes all intermediate files to force full rebuild
clean:
	-rm -rf $(WORKDIR) $(OUTPUT) Makefile.depend

# Runs the DLX simulator with $(EXEC) as user-space program
run:
	-cd $(OUTDIR); dlxsim -x $(OSEXEC) -a -u $(EXEC)

# Includes added dependencies of source files on header files
include Makefile.depend
